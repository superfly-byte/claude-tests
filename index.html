<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FuelUp ‚Äì Youth Athlete Nutrition</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --navy:    #1B2A4A;
      --orange:  #FF6B35;
      --green:   #27AE60;
      --light:   #F0F4F8;
      --white:   #FFFFFF;
      --muted:   #64748B;
      --border:  #E2E8F0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--light);
      color: var(--navy);
      min-height: 100vh;
      max-width: 520px;
      margin: 0 auto;
    }

    .screen { display: none; min-height: 100vh; flex-direction: column; }
    .screen.active { display: flex; }

    .header {
      background: var(--navy);
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .logo { font-size: 22px; font-weight: 900; letter-spacing: -0.5px; }
    .logo .fuel { color: var(--orange); }
    .logo .up   { color: #fff; }
    .header-btn {
      color: #fff;
      background: rgba(255,255,255,0.12);
      border: none;
      font-size: 13px;
      font-weight: 600;
      padding: 7px 14px;
      border-radius: 8px;
      cursor: pointer;
    }
    .back-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .spacer { width: 44px; }

    .content { flex: 1; padding: 24px 20px; overflow-y: auto; }

    h1 { font-size: 24px; font-weight: 800; margin-bottom: 6px; }
    .subtitle { color: var(--muted); font-size: 14px; margin-bottom: 28px; line-height: 1.5; }

    .form-group { margin-bottom: 22px; }
    label {
      display: block;
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      margin-bottom: 8px;
    }
    input, select {
      width: 100%;
      padding: 13px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 16px;
      color: var(--navy);
      background: #fff;
      appearance: none;
      -webkit-appearance: none;
      transition: border-color 0.15s;
    }
    input:focus, select:focus { outline: none; border-color: var(--orange); }
    .select-wrap { position: relative; }
    .select-wrap::after {
      content: '‚ñæ';
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      pointer-events: none;
      font-size: 14px;
    }

    .gender-toggle {
      display: grid;
      grid-template-columns: 1fr 1fr;
      border: 2px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .gender-btn {
      padding: 13px;
      border: none;
      background: #fff;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }
    .gender-btn.selected { background: var(--orange); color: #fff; font-weight: 700; }

    .btn {
      display: block;
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      text-align: center;
      transition: opacity 0.15s, transform 0.1s;
    }
    .btn:active { transform: scale(0.98); opacity: 0.9; }
    .btn-primary  { background: var(--orange); color: #fff; }
    .btn-navy     { background: var(--navy);   color: #fff; }

    .option-group { display: grid; gap: 10px; }
    .option-btn {
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: #fff;
      text-align: left;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 14px;
      transition: all 0.15s;
    }
    .option-btn.selected {
      border-color: var(--orange);
      background: #FFF5F0;
      color: var(--orange);
      font-weight: 700;
    }
    .option-btn .icon { font-size: 22px; width: 28px; text-align: center; }
    .option-sub { font-size: 12px; color: var(--muted); font-weight: 400; margin-top: 2px; }
    .option-btn.selected .option-sub { color: #e05020; }

    .profile-card {
      background: var(--navy);
      color: #fff;
      border-radius: 16px;
      padding: 22px;
      margin-bottom: 24px;
    }
    .athlete-name    { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
    .athlete-details { font-size: 13px; opacity: 0.65; margin-bottom: 18px; }
    .profile-stats   { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .stat-box { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 12px; }
    .stat-val { font-size: 18px; font-weight: 800; }
    .stat-lbl { font-size: 11px; opacity: 0.65; text-transform: uppercase; letter-spacing: 0.4px; margin-top: 2px; }

    .results-header { background: var(--navy); color: #fff; padding: 20px; flex-shrink: 0; }
    .meal-context { font-size: 13px; opacity: 0.65; margin-bottom: 4px; }
    .meal-title   { font-size: 20px; font-weight: 800; margin-bottom: 14px; }
    .target-row   { display: flex; gap: 8px; flex-wrap: wrap; }
    .target-chip  {
      background: rgba(255,255,255,0.15);
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .restaurant-list { flex: 1; overflow-y: auto; }
    .restaurant-card { background: #fff; padding: 20px; border-bottom: 8px solid var(--light); }
    .chain-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }
    .chain-name { font-size: 17px; font-weight: 800; display: flex; align-items: center; gap: 8px; }

    .menu-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 10px;
    }
    .item-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
      gap: 8px;
    }
    .item-name { font-size: 14px; font-weight: 700; flex: 1; }
    .item-note { font-size: 11px; color: var(--muted); font-style: italic; margin-top: 3px; }
    .score-badge {
      display: inline-flex;
      align-items: center;
      border-radius: 20px;
      padding: 3px 10px;
      font-size: 11px;
      font-weight: 700;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .badge-great { background: #D5F5E3; color: #1E8449; }
    .badge-good  { background: #FEF9E7; color: #B7770D; }
    .badge-ok    { background: #EAECEE; color: #555; }

    .macro-row { display: flex; gap: 6px; flex-wrap: wrap; }
    .macro-pill {
      border-radius: 20px;
      padding: 3px 10px;
      font-size: 11px;
      font-weight: 600;
    }
    .pill-cal  { background: #FEF3C7; color: #92400E; }
    .pill-pro  { background: #D1FAE5; color: #065F46; }
    .pill-carb { background: #DBEAFE; color: #1E40AF; }
    .pill-fat  { background: #FCE7F3; color: #9D174D; }

    .find-btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: var(--navy);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      margin-top: 14px;
    }

    .warning {
      background: #FFF3E0;
      border-left: 4px solid var(--orange);
      padding: 14px 18px;
      font-size: 13px;
      line-height: 1.5;
    }
    .warning strong { display: block; margin-bottom: 4px; font-size: 14px; }

    .footer-space { height: 32px; }
  </style>
</head>
<body>

<div id="screen-profile" class="screen">
  <div class="header">
    <div class="logo"><span class="fuel">Fuel</span><span class="up">Up</span></div>
  </div>
  <div class="content">
    <h1>Set Up Your Athlete</h1>
    <p class="subtitle">We use this to calculate personalized nutrition targets based on your child's sport and body.</p>

    <div class="form-group">
      <label>Athlete's First Name</label>
      <input type="text" id="inp-name" placeholder="e.g. Alex" maxlength="30" autocomplete="off">
    </div>

    <div class="form-group">
      <label>Gender</label>
      <div class="gender-toggle">
        <button class="gender-btn selected" data-g="male"   onclick="selectGender('male')">Male</button>
        <button class="gender-btn"          data-g="female" onclick="selectGender('female')">Female</button>
      </div>
    </div>

    <div class="form-group">
      <label>Age</label>
      <div class="select-wrap">
        <select id="inp-age">
          <option value="">Select age</option>
          <option value="8">8</option><option value="9">9</option><option value="10">10</option>
          <option value="11">11</option><option value="12">12</option><option value="13">13</option>
          <option value="14">14</option><option value="15">15</option><option value="16">16</option>
          <option value="17">17</option><option value="18">18</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>Weight (lbs)</label>
      <input type="number" id="inp-weight" placeholder="e.g. 130" min="50" max="350">
    </div>

    <div class="form-group">
      <label>Sport</label>
      <div class="select-wrap">
        <select id="inp-sport">
          <option value="">Select sport</option>
          <option value="soccer">Soccer</option>
          <option value="hockey">Hockey (Ice)</option>
          <option value="basketball">Basketball</option>
          <option value="baseball">Baseball</option>
          <option value="softball">Softball</option>
          <option value="football">Football</option>
          <option value="lacrosse">Lacrosse</option>
          <option value="swimming">Swimming</option>
          <option value="volleyball">Volleyball</option>
          <option value="tennis">Tennis</option>
          <option value="wrestling">Wrestling</option>
          <option value="gymnastics">Gymnastics</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>Training Days Per Week</label>
      <div class="select-wrap">
        <select id="inp-days">
          <option value="">Select days</option>
          <option value="3">3 days/week</option>
          <option value="4">4 days/week</option>
          <option value="5">5 days/week</option>
          <option value="6">6 days/week</option>
          <option value="7">7 days/week</option>
        </select>
      </div>
    </div>

    <button class="btn btn-primary" onclick="saveProfile()">Save Profile ‚Üí</button>
    <div class="footer-space"></div>
  </div>
</div>


<div id="screen-home" class="screen">
  <div class="header">
    <div class="logo"><span class="fuel">Fuel</span><span class="up">Up</span></div>
    <button class="header-btn" onclick="editProfile()">Edit Profile</button>
  </div>
  <div class="content">
    <div id="home-card" class="profile-card"></div>
    <button class="btn btn-primary" style="font-size:18px;padding:20px;margin-bottom:12px;"
      onclick="showScreen('session')">
      üçΩÔ∏è Find Food Now
    </button>
    <p style="text-align:center;font-size:13px;color:var(--muted);">
      Get restaurant picks tailored to today's activity.
    </p>
    <div class="footer-space"></div>
  </div>
</div>


<div id="screen-session" class="screen">
  <div class="header">
    <button class="back-btn" onclick="showScreen('home')">‚Üê</button>
    <div class="logo"><span class="fuel">Fuel</span><span class="up">Up</span></div>
    <div class="spacer"></div>
  </div>
  <div class="content">
    <h1>Today's Activity</h1>
    <p class="subtitle">Tell us what's happening so we can find the right fuel.</p>

    <div class="form-group">
      <label>What's happening today?</label>
      <div class="option-group">
        <button class="option-btn" data-v="practice" onclick="selectActivity('practice')">
          <span class="icon">üèÉ</span>
          <div><div>Practice Only</div><div class="option-sub">Single training session</div></div>
        </button>
        <button class="option-btn" data-v="game" onclick="selectActivity('game')">
          <span class="icon">üèÜ</span>
          <div><div>Game Only</div><div class="option-sub">Single game or match</div></div>
        </button>
        <button class="option-btn" data-v="practice_game" onclick="selectActivity('practice_game')">
          <span class="icon">‚ö°</span>
          <div><div>Practice + Game</div><div class="option-sub">Double-session day</div></div>
        </button>
        <button class="option-btn" data-v="rest" onclick="selectActivity('rest')">
          <span class="icon">üò¥</span>
          <div><div>Rest Day</div><div class="option-sub">No activity today</div></div>
        </button>
      </div>
    </div>

    <div id="timing-section" class="form-group" style="display:none;">
      <label>When is the next activity?</label>
      <input type="time" id="inp-time">
      <p style="font-size:12px;color:var(--muted);margin-top:6px;">
        Current time: <span id="now-display"></span>
      </p>
    </div>

    <button class="btn btn-primary" id="recs-btn" style="display:none;"
      onclick="buildResults()">
      Get Recommendations ‚Üí
    </button>
    <div class="footer-space"></div>
  </div>
</div>


<div id="screen-results" class="screen">
  <div class="results-header">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;">
      <button class="back-btn" onclick="showScreen('session')">‚Üê</button>
      <div class="logo"><span class="fuel">Fuel</span><span class="up">Up</span></div>
    </div>
    <div class="meal-context" id="res-context"></div>
    <div class="meal-title"   id="res-title"></div>
    <div class="target-row"   id="res-targets"></div>
  </div>
  <div class="restaurant-list" id="res-list"></div>
</div>


<script>
'use strict';

const CHAINS = {
  chipotle: {
    name: 'Chipotle Mexican Grill', emoji: 'üåØ',
    items: [
      { name: 'Chicken Burrito Bowl',         cal: 665, pro: 51, carb: 74, fat: 17, kid: true,  note: 'Brown rice + black beans + chicken + salsa' },
      { name: 'Chicken Burrito',              cal: 865, pro: 54, carb: 99, fat: 24, kid: true,  note: 'Flour tortilla + rice + beans + chicken + salsa' },
      { name: 'Steak Burrito Bowl',           cal: 655, pro: 46, carb: 74, fat: 17, kid: true,  note: 'Brown rice + black beans + steak + salsa' },
      { name: 'Kids Quesadilla (Chicken)',    cal: 500, pro: 28, carb: 47, fat: 20, kid: true,  note: 'Smaller portion ‚Äì great for younger athletes' },
      { name: 'Veggie Bowl',                  cal: 540, pro: 17, carb: 77, fat: 16, kid: true,  note: 'Brown rice + beans + fajita veggies + guac' },
      { name: 'Barbacoa Bowl',                cal: 635, pro: 44, carb: 74, fat: 18, kid: false, note: 'Brown rice + black beans + barbacoa + salsa' },
    ]
  },
  panera: {
    name: 'Panera Bread', emoji: 'ü•ñ',
    items: [
      { name: 'Frontega Chicken Panini',          cal: 620, pro: 39, carb: 62, fat: 21, kid: true,  note: 'Great balance of protein and carbs' },
      { name: 'Turkey Sandwich (whole)',           cal: 430, pro: 24, carb: 56, fat: 10, kid: true,  note: 'Lean protein on whole grain bread' },
      { name: 'Grilled Chicken Salad',             cal: 500, pro: 35, carb: 28, fat: 27, kid: false, note: 'High protein, lower carb ‚Äì best post-game' },
      { name: 'Kids Mac & Cheese + Apple',         cal: 500, pro: 16, carb: 73, fat: 17, kid: true,  note: 'High carb ‚Äì solid pre-game for younger kids' },
      { name: 'Chicken Noodle Soup + Whole Bagel', cal: 490, pro: 21, carb: 77, fat:  8, kid: true,  note: 'Easy on the stomach, good pre-game option' },
      { name: 'Mediterranean Veggie Sandwich',     cal: 580, pro: 20, carb: 86, fat: 13, kid: false, note: 'High carb load, lower protein' },
    ]
  },
  chickfila: {
    name: "Chick-fil-A", emoji: 'üêî',
    items: [
      { name: 'Grilled Chicken Sandwich',           cal: 380, pro: 28, carb: 42, fat:  7, kid: true,  note: 'Best balance for athletes ‚Äì lean and filling' },
      { name: 'Grilled Chicken Cool Wrap',          cal: 350, pro: 37, carb: 30, fat:  8, kid: true,  note: 'Highest protein option on the menu' },
      { name: '8-Count Grilled Nuggets + Fruit Cup',cal: 210, pro: 26, carb: 18, fat:  4, kid: true,  note: 'Light, high-protein ‚Äì great pre-game snack' },
      { name: 'Chick-fil-A Sandwich + Fruit Cup',   cal: 540, pro: 29, carb: 65, fat: 17, kid: true,  note: 'Classic kid favorite with added vitamins' },
      { name: '8-Count Nuggets + Waffle Fries',     cal: 680, pro: 31, carb: 68, fat: 32, kid: true,  note: 'Higher fat ‚Äì better for post-game recovery' },
      { name: 'Kids Grilled Nuggets Meal',          cal: 380, pro: 19, carb: 48, fat: 11, kid: true,  note: 'Perfect size for younger or smaller athletes' },
    ]
  },
  subway: {
    name: 'Subway', emoji: 'ü•ô',
    items: [
      { name: 'Footlong Rotisserie Chicken', cal: 620, pro: 46, carb: 92, fat:  9, kid: true,  note: 'On 9-grain wheat ‚Äì excellent athlete meal' },
      { name: 'Footlong Turkey Breast',      cal: 560, pro: 36, carb: 92, fat:  7, kid: true,  note: 'On 9-grain wheat with veggies' },
      { name: '6" Rotisserie Chicken',       cal: 310, pro: 23, carb: 46, fat:  5, kid: true,  note: 'Good lighter option' },
      { name: '6" Turkey Breast',            cal: 280, pro: 18, carb: 46, fat:  4, kid: true,  note: 'Lean and simple' },
      { name: '6" Black Forest Ham',         cal: 290, pro: 18, carb: 46, fat:  5, kid: true,  note: 'Kid-friendly classic' },
      { name: 'Footlong Black Forest Ham',   cal: 580, pro: 36, carb: 92, fat:  9, kid: true,  note: 'Good carb load for game day' },
    ]
  },
  panda: {
    name: 'Panda Express', emoji: 'ü•°',
    items: [
      { name: 'Grilled Teriyaki Chicken + Brown Rice', cal: 680, pro: 45, carb: 100, fat: 15, kid: true,  note: 'Best combo ‚Äì high protein + complex carbs' },
      { name: 'String Bean Chicken + Steamed Rice',    cal: 570, pro: 21, carb:  99, fat:  9, kid: true,  note: 'Light protein, great carb source' },
      { name: 'Kung Pao Chicken + Brown Rice',         cal: 710, pro: 28, carb: 108, fat: 17, kid: false, note: 'Spicy ‚Äì may not suit all kids' },
      { name: 'Broccoli Beef + Steamed Rice',          cal: 530, pro: 16, carb:  99, fat:  7, kid: true,  note: 'Lower protein ‚Äì add an extra protein side if needed' },
      { name: 'Grilled Teriyaki Chicken + Chow Mein',  cal: 810, pro: 49, carb:  93, fat: 28, kid: true,  note: 'High calorie ‚Äì great for intense double-session days' },
      { name: 'String Bean Chicken + Mixed Veggies',   cal: 260, pro: 17, carb:  26, fat: 10, kid: true,  note: 'Light, low-calorie ‚Äì good for rest days' },
    ]
  },
  mcdonalds: {
    name: "McDonald's", emoji: 'üçü',
    items: [
      { name: 'Grilled Chicken Sandwich',         cal: 380, pro: 37, carb: 44, fat:  6, kid: true,  note: 'Best option on the menu for athletes' },
      { name: 'McDouble + Apple Slices',          cal: 415, pro: 23, carb: 38, fat: 20, kid: true,  note: 'Familiar + fruit adds vitamins' },
      { name: '10-pc Grilled Nuggets*',           cal: 230, pro: 38, carb:  2, fat:  6, kid: true,  note: '*Ask at counter. Very high protein, low carb.' },
      { name: 'Fruit & Maple Oatmeal',            cal: 320, pro:  6, carb: 64, fat:  4, kid: true,  note: 'Great morning pre-game carb load' },
      { name: 'Hamburger Happy Meal (w/ apples)', cal: 475, pro: 17, carb: 58, fat: 18, kid: true,  note: 'With apple slices ‚Äì good for younger kids' },
      { name: '10-pc McNuggets + Side Salad',     cal: 435, pro: 25, carb: 29, fat: 25, kid: true,  note: 'Kid favorite with added greens' },
    ]
  }
};

const SPORT_TYPE = {
  soccer:'endurance', hockey:'endurance', swimming:'endurance',
  basketball:'mixed', lacrosse:'mixed', volleyball:'mixed', tennis:'mixed', gymnastics:'mixed',
  baseball:'power', softball:'power', football:'power', wrestling:'power'
};

const SPORT_LABELS = {
  soccer:'Soccer', hockey:'Hockey', basketball:'Basketball', baseball:'Baseball',
  softball:'Softball', football:'Football', lacrosse:'Lacrosse', swimming:'Swimming',
  volleyball:'Volleyball', tennis:'Tennis', wrestling:'Wrestling', gymnastics:'Gymnastics'
};

function dailyNeeds(p) {
  const kg = p.weight * 0.453592;
  let bmr;
  if (p.gender === 'male') {
    bmr = p.age <= 10 ? (22.7 * kg + 505) : (17.7 * kg + 657);
  } else {
    bmr = p.age <= 10 ? (22.5 * kg + 499) : (13.4 * kg + 692);
  }
  const af = 1.60 + (parseInt(p.days) - 3) * 0.0625;
  const cal = bmr * Math.min(af, 1.90);
  const proMult = (p.gender === 'male') ? 1.6 : 1.4;
  const pro = proMult * kg;
  const carbMult = { endurance: 6.5, mixed: 5.8, power: 5.0 }[SPORT_TYPE[p.sport]] || 5.8;
  const carb = carbMult * kg;
  const fat = Math.max((cal - pro * 4 - carb * 4) / 9, kg * 1.0);
  return { cal, pro, carb, fat };
}

function mealTarget(daily, actType, hoursUntil) {
  let fraction = 0.27;
  let type;
  if (actType === 'rest') {
    type = 'rest'; fraction = 0.30;
  } else if (hoursUntil === null) {
    type = 'recovery'; fraction = 0.30;
  } else if (hoursUntil >= 2) {
    type = 'pre_full'; fraction = 0.30;
  } else if (hoursUntil >= 1) {
    type = 'pre_light'; fraction = 0.22;
  } else {
    type = 'pre_snack'; fraction = 0.15;
  }
  const ratios = {
    pre_full:  { c: 0.55, p: 0.25, f: 0.20 },
    pre_light: { c: 0.65, p: 0.22, f: 0.13 },
    pre_snack: { c: 0.70, p: 0.20, f: 0.10 },
    recovery:  { c: 0.50, p: 0.35, f: 0.15 },
    rest:      { c: 0.45, p: 0.30, f: 0.25 },
  };
  const r   = ratios[type];
  const cal = daily.cal * fraction;
  return {
    type,
    cal:  Math.round(cal),
    pro:  Math.round((cal * r.p) / 4),
    carb: Math.round((cal * r.c) / 4),
    fat:  Math.round((cal * r.f) / 9),
  };
}

function macroScore(ratio) {
  const d = Math.abs(ratio - 1.0);
  if (ratio >= 0.70 && ratio <= 1.30) return 1.0  - d * 0.50;
  if (ratio >= 0.45 && ratio <= 1.55) return 0.60 - d * 0.30;
  return Math.max(0, 0.25 - d * 0.08);
}

function scoreItem(item, tgt) {
  const s = macroScore(item.cal  / tgt.cal)  * 0.20
          + macroScore(item.pro  / tgt.pro)  * 0.35
          + macroScore(item.carb / tgt.carb) * 0.35
          + macroScore(item.fat  / tgt.fat)  * 0.10;
  return Math.min(100, Math.round(s * 100) + (item.kid ? 5 : 0));
}

function badgeFor(score) {
  if (score >= 72) return { label: '‚úì Great Match', cls: 'badge-great' };
  if (score >= 50) return { label: '‚úì Good Match',  cls: 'badge-good'  };
  return               { label: 'Decent Option',    cls: 'badge-ok'    };
}

let profile = null;
let selectedGender = 'male';
let selectedActivity = null;

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
  window.scrollTo(0, 0);
}

function selectGender(g) {
  selectedGender = g;
  document.querySelectorAll('.gender-btn').forEach(b =>
    b.classList.toggle('selected', b.dataset.g === g)
  );
}

function saveProfile() {
  const name   = document.getElementById('inp-name').value.trim();
  const age    = parseInt(document.getElementById('inp-age').value);
  const weight = parseFloat(document.getElementById('inp-weight').value);
  const sport  = document.getElementById('inp-sport').value;
  const days   = document.getElementById('inp-days').value;
  if (!name || !age || !weight || !sport || !days) {
    alert('Please fill in all fields before continuing.');
    return;
  }
  if (weight < 40 || weight > 400) {
    alert('Please enter a valid weight between 40 and 400 lbs.');
    return;
  }
  profile = { name, gender: selectedGender, age, weight, sport, days };
  localStorage.setItem('fu_profile', JSON.stringify(profile));
  renderHome();
  showScreen('home');
}

function editProfile() {
  if (!profile) return;
  document.getElementById('inp-name').value   = profile.name;
  document.getElementById('inp-age').value    = profile.age;
  document.getElementById('inp-weight').value = profile.weight;
  document.getElementById('inp-sport').value  = profile.sport;
  document.getElementById('inp-days').value   = profile.days;
  selectedGender = profile.gender;
  document.querySelectorAll('.gender-btn').forEach(b =>
    b.classList.toggle('selected', b.dataset.g === profile.gender)
  );
  showScreen('profile');
}

function renderHome() {
  if (!profile) return;
  const d = dailyNeeds(profile);
  document.getElementById('home-card').innerHTML = `
    <div class="athlete-name">‚ö° ${esc(profile.name)}</div>
    <div class="athlete-details">
      ${profile.gender === 'male' ? 'Male' : 'Female'} &nbsp;¬∑&nbsp;
      ${profile.age} yrs &nbsp;¬∑&nbsp;
      ${profile.weight} lbs
    </div>
    <div class="profile-stats">
      <div class="stat-box">
        <div class="stat-val">${SPORT_LABELS[profile.sport] || profile.sport}</div>
        <div class="stat-lbl">Sport</div>
      </div>
      <div class="stat-box">
        <div class="stat-val">${profile.days}√ó/week</div>
        <div class="stat-lbl">Training</div>
      </div>
      <div class="stat-box">
        <div class="stat-val">${Math.round(d.cal).toLocaleString()}</div>
        <div class="stat-lbl">Daily Cal Target</div>
      </div>
      <div class="stat-box">
        <div class="stat-val">${Math.round(d.pro)}g</div>
        <div class="stat-lbl">Daily Protein</div>
      </div>
    </div>
  `;
}

function selectActivity(val) {
  selectedActivity = val;
  document.querySelectorAll('.option-btn').forEach(b =>
    b.classList.toggle('selected', b.dataset.v === val)
  );
  const timingEl = document.getElementById('timing-section');
  const recsBtn  = document.getElementById('recs-btn');
  if (val === 'rest') {
    timingEl.style.display = 'none';
  } else {
    timingEl.style.display = 'block';
    const def = new Date(Date.now() + 2 * 3600000);
    document.getElementById('inp-time').value =
      String(def.getHours()).padStart(2,'0') + ':' +
      String(def.getMinutes()).padStart(2,'0');
    const now = new Date();
    document.getElementById('now-display').textContent =
      String(now.getHours()).padStart(2,'0') + ':' +
      String(now.getMinutes()).padStart(2,'0');
  }
  recsBtn.style.display = 'block';
}

function buildResults() {
  if (!selectedActivity) { alert('Please choose what\'s happening today.'); return; }
  let hoursUntil = null;
  if (selectedActivity !== 'rest') {
    const timeStr = document.getElementById('inp-time').value;
    if (!timeStr) { alert('Please enter the activity time.'); return; }
    const [h, m]  = timeStr.split(':').map(Number);
    const actDate = new Date();
    actDate.setHours(h, m, 0, 0);
    const diffH = (actDate - Date.now()) / 3600000;
    hoursUntil = diffH < -1 ? null : diffH;
  }
  renderResults(hoursUntil);
  showScreen('results');
}

function renderResults(hoursUntil) {
  const d   = dailyNeeds(profile);
  const tgt = mealTarget(d, selectedActivity, hoursUntil);

  const actLabels = {
    practice: 'Practice Day', game: 'Game Day',
    practice_game: 'Practice + Game Day', rest: 'Rest Day'
  };
  const mealLabels = {
    pre_full:  'Pre-Activity Meal',
    pre_light: 'Light Pre-Activity Meal',
    pre_snack: 'Pre-Activity Snack',
    recovery:  'Post-Activity Recovery Meal',
    rest:      'Rest Day Meal'
  };

  let timing = '';
  if (hoursUntil !== null && selectedActivity !== 'rest') {
    const h = Math.floor(hoursUntil), mn = Math.round((hoursUntil - h) * 60);
    timing = ` ¬∑ ${h > 0 ? h + 'h ' : ''}${mn}m until activity`;
  } else if (hoursUntil === null && selectedActivity !== 'rest') {
    timing = ' ¬∑ Post-activity';
  }

  document.getElementById('res-context').textContent =
    `${profile.name} ¬∑ ${actLabels[selectedActivity]}${timing}`;
  document.getElementById('res-title').textContent = mealLabels[tgt.type];
  document.getElementById('res-targets').innerHTML = `
    <span class="target-chip">üî• ~${tgt.cal} cal</span>
    <span class="target-chip">üí™ ~${tgt.pro}g protein</span>
    <span class="target-chip">‚ö° ~${tgt.carb}g carbs</span>
    <span class="target-chip">ü´ô ~${tgt.fat}g fat</span>
  `;

  const allScored = [];
  Object.entries(CHAINS).forEach(([key, chain]) => {
    chain.items.forEach(item => {
      allScored.push({ key, chain, item, score: scoreItem(item, tgt) });
    });
  });
  allScored.sort((a, b) => b.score - a.score);

  const byChain = {};
  allScored.forEach(({ key, chain, item, score }) => {
    if (!byChain[key]) byChain[key] = { chain, picks: [], best: 0 };
    if (byChain[key].picks.length < 2) {
      byChain[key].picks.push({ item, score });
      byChain[key].best = Math.max(byChain[key].best, score);
    }
  });

  const sorted = Object.entries(byChain).sort((a, b) => b[1].best - a[1].best);

  const listEl = document.getElementById('res-list');
  let html = '';

  if (tgt.type === 'pre_snack') {
    html += `<div class="warning">
      <strong>‚ö†Ô∏è Less than 1 hour before activity</strong>
      Eating a large meal this close to activity can cause discomfort.
      Consider just a small portion, or a banana and water.
    </div>`;
  }

  sorted.forEach(([, { chain, picks }]) => {
    const itemsHtml = picks.map(({ item, score }) => {
      const b = badgeFor(score);
      return `
        <div class="menu-item">
          <div class="item-top">
            <div>
              <div class="item-name">${esc(item.name)}</div>
              ${item.note ? `<div class="item-note">${esc(item.note)}</div>` : ''}
            </div>
            <span class="score-badge ${b.cls}">${b.label}</span>
          </div>
          <div class="macro-row">
            <span class="macro-pill pill-cal">üî• ${item.cal} cal</span>
            <span class="macro-pill pill-pro">üí™ ${item.pro}g protein</span>
            <span class="macro-pill pill-carb">‚ö° ${item.carb}g carbs</span>
            <span class="macro-pill pill-fat">ü´ô ${item.fat}g fat</span>
          </div>
        </div>`;
    }).join('');

    const mapsUrl = 'https://maps.google.com/maps?q=' +
      encodeURIComponent(chain.name + ' near me');

    html += `
      <div class="restaurant-card">
        <div class="chain-header">
          <div class="chain-name">
            <span>${chain.emoji}</span>
            <span>${esc(chain.name)}</span>
          </div>
        </div>
        ${itemsHtml}
        <a class="find-btn" href="${mapsUrl}" target="_blank" rel="noopener noreferrer">
          üìç Find Nearest ${esc(chain.name.split(' ')[0])}
        </a>
      </div>`;
  });

  listEl.innerHTML = html;
}

function esc(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

(function init() {
  try {
    const saved = localStorage.getItem('fu_profile');
    if (saved) {
      profile = JSON.parse(saved);
      selectedGender = profile.gender;
      renderHome();
      showScreen('home');
      return;
    }
  } catch (e) { /* ignore */ }
  showScreen('profile');
})();
</script>
</body>
</html>
